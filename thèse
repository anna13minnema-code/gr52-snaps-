gr52-snaps/
â”œâ”€ index.html
â”œâ”€ app.js
â”œâ”€ style.css
â”œâ”€ manifest.json
â”œâ”€ service-worker.js
â”œâ”€ _redirects
â”œâ”€ netlify.toml
â”œâ”€ package.json
â””â”€ functions/
    â””â”€ upload-photo.js

 1) index.html
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GR52 Snaps</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <header>
      <h1>GR52 Snaps</h1>
      <p>Point : <strong id="point-id"></strong></p>
    </header>

    <section>
      <div class="preview-wrap">
        <img id="preview" />
      </div>

      <input id="file-input" type="file" accept="image/*" capture="environment" hidden />
      <button id="take-photo">ğŸ“¸ Prendre une photo</button>
      <button id="choose-photo">ğŸ–¼ï¸ Choisir une photo</button>
      <button id="send-photo" disabled>ğŸ“¤ Envoyer</button>

      <p id="status"></p>
      <div id="log"></div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>

2) `app.js`

```javascript
// Initialisation du front-end GR52 Snaps

const SUPABASE_URL = 'VOTRE_SUPABASE_URL';
const SUPABASE_KEY = 'VOTRE_SUPABASE_SERVICE_KEY';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const pointId = new URLSearchParams(window.location.search).get('point') || 'unknown';
document.getElementById('point-id').textContent = pointId;

const fileInput = document.getElementById('file-input');
const takePhotoBtn = document.getElementById('take-photo');
const choosePhotoBtn = document.getElementById('choose-photo');
const sendPhotoBtn = document.getElementById('send-photo');
const previewImg = document.getElementById('preview');
const statusP = document.getElementById('status');

let currentFile = null;

takePhotoBtn.addEventListener('click', () => fileInput.click());
choosePhotoBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  currentFile = file;
  previewImg.src = URL.createObjectURL(file);
  sendPhotoBtn.disabled = false;
});

sendPhotoBtn.addEventListener('click', async () => {
  if (!currentFile) return;
  statusP.textContent = 'Envoi en cours...';

  const formData = new FormData();
  formData.append('photo', currentFile);
  formData.append('point_id', pointId);

  try {
    const res = await fetch('/.netlify/functions/upload-photo', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();
    if (res.ok) statusP.textContent = 'Photo envoyÃ©e !';
    else statusP.textContent = 'Erreur : ' + data.error;

  } catch (err) {
    statusP.textContent = 'Erreur rÃ©seau';
    console.error(err);
  }
});
```

---

3)  `styles.css`

Tu mets ce que tu veux. Exemple minimal :

```css
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}

.container {
  max-width: 600px;
  margin: auto;
}

.preview-wrap img {
  width: 100%;
  margin: 10px 0;
}
```
4) `manifest.json`

```json
{
  "name": "GR52 Snaps",
  "short_name": "GR52",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#559c87ff",
  "background_color": "#ffffff",
  "icons": [
    { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

5) `service-worker.js`

```javascript
self.addEventListener('install', () => {
  console.log('Service Worker installÃ©');
  self.skipWaiting();
});

self.addEventListener('activate', () => {
  console.log('Service Worker activÃ©');
});

self.addEventListener('fetch', () => {});
```

---
6 ) `netlify.toml` (Ã  la racine)

[build]
  publish = "."
  functions = "functions"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

---

7)  `package.json` (Ã  la racine)

{
  "name": "gr52-snaps",
  "version": "1.0.0",
  "type": "commonjs",
  "dependencies": {
    "@supabase/supabase-js": "^2.40.0",
    "busboy": "^1.6.0"
  },
  "scripts": {
    "start": "echo 'Nothing to build, just serving static files'",
    "build": "echo 'Nothing to build, just serving static files'"
  }
}


---



8) `functions/upload-photo.js`

```javascript
const Busboy = require('busboy');
const { createClient } = require('@supabase/supabase-js');

exports.handler = async (event) => {
  if (event.httpMethod !== 'POST')
    return { statusCode: 405, body: 'MÃ©thode non autorisÃ©e' };

  const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );

  return new Promise((resolve) => {
    const busboy = Busboy({ headers: event.headers });
    const fields = {};
    let uploadedFile = null;

    busboy.on('file', (field, file, filename) => {
      let chunks = [];
      file.on('data', (data) => chunks.push(data));
      file.on('end', () => {
        uploadedFile = { filename, buffer: Buffer.concat(chunks) };
      });
    });

    busboy.on('field', (name, value) => (fields[name] = value));

    busboy.on('finish', async () => {
      try {
        const path = `${fields.point_id}/${Date.now()}-${uploadedFile.filename}`;

        const { error: uploadError } = await supabase
          .storage.from(process.env.SUPABASE_BUCKET)
          .upload(path, uploadedFile.buffer);

        if (uploadError) throw uploadError;

        const { data: urlData } = supabase.storage
          .from(process.env.SUPABASE_BUCKET)
          .getPublicUrl(path);

        await supabase.from('photos').insert({
          point_id: fields.point_id,
          storage_path: path,
          public_url: urlData.publicUrl,
        });

        resolve({
          statusCode: 200,
          body: JSON.stringify({ url: urlData.publicUrl })
        });
      } catch (err) {
        resolve({
          statusCode: 500,
          body: JSON.stringify({ error: err.message })
        });
      }
    });

    busboy.end(Buffer.from(event.body, 'base64'));
  });
};
```

---


9) `infra/supabase.sql`

```sql
create table if not exists public.photos (
  id bigserial primary key,
  point_id text,
  taken_at timestamptz default now(),
  user_agent text,
  storage_path text,
  public_url text,
  created_at timestamptz default now()
);
```

---



